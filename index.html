<!-- Three.js UMD (pas de module) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/controls/OrbitControls.js"></script>

<script>
  (function(){
    var container = document.getElementById('stage3d');
    if(!container){ return; }

    var scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf8f8f6);

    var renderer = new THREE.WebGLRenderer({antialias:true, preserveDrawingBuffer:true});
    container.appendChild(renderer.domElement);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 1.8));

    var camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
    camera.position.set(0.9, 1.5, 4.2);

    var controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.target.set(0, 1.25, 0);
    controls.update();

    // Lumières
    scene.add(new THREE.HemisphereLight(0xffffff, 0xbbbbaa, 0.9));
    var dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(2.5,4,3);
    scene.add(dir);

    // Pièce (sol + 2 murs)
    var grp = new THREE.Group(); scene.add(grp);
    var floor = new THREE.Mesh(
      new THREE.PlaneGeometry(8,6),
      new THREE.MeshStandardMaterial({color:0xdddddd, roughness:0.95})
    );
    floor.rotation.x = -Math.PI/2; grp.add(floor);

    var wallMat = new THREE.MeshStandardMaterial({color:0xf4f4f4});
    var wall = new THREE.Mesh(new THREE.PlaneGeometry(4.5,2.7), wallMat);
    wall.position.set(0,1.35,-1.8); grp.add(wall);

    var wall2 = new THREE.Mesh(
      new THREE.PlaneGeometry(3.2,2.7),
      new THREE.MeshStandardMaterial({color:0xeeeeee})
    );
    wall2.position.set(-2.25,1.35,-0.2);
    wall2.rotation.y = Math.PI/2.6; grp.add(wall2);

    function resize(){
      var w = container.clientWidth;
      var h = container.clientHeight || 520;
      renderer.setSize(w,h);
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
    }
    new ResizeObserver(resize).observe(container);
    resize();

    var loader = new THREE.TextureLoader(); var motif = null;
    var $ = function(id){ return document.getElementById(id); };
    var ui = { scale: $('scale'), rotation: $('rotation'), offx: $('offx'), offy: $('offy') };

    function applyTex(tex){
      tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
      tex.repeat.set(parseFloat(ui.scale.value||1), parseFloat(ui.scale.value||1));
      tex.rotation = THREE.MathUtils.degToRad(parseFloat(ui.rotation.value||0));
      tex.offset.set(parseFloat(ui.offx.value||0), parseFloat(ui.offy.value||0));
      wall.material.map = tex; wall.material.needsUpdate = true;
    }

    var fileInput = $('fileInput');
    if(fileInput){
      fileInput.addEventListener('change', function(e){
        var f = e.target.files && e.target.files[0]; if(!f) return;
        var url = URL.createObjectURL(f);
        loader.load(url, function(t){ motif = t; applyTex(motif); URL.revokeObjectURL(url); });
      });
    }

    ['input','change'].forEach(function(evt){
      ui.scale && ui.scale.addEventListener(evt, function(){ if(motif){ motif.repeat.set(+ui.scale.value, +ui.scale.value); motif.needsUpdate=true; }});
      ui.rotation && ui.rotation.addEventListener(evt, function(){ if(motif){ motif.rotation = THREE.MathUtils.degToRad(+ui.rotation.value); motif.needsUpdate=true; }});
      ui.offx && ui.offx.addEventListener(evt, function(){ if(motif){ motif.offset.x = +ui.offx.value; motif.needsUpdate=true; }});
      ui.offy && ui.offy.addEventListener(evt, function(){ if(motif){ motif.offset.y = +ui.offy.value; motif.needsUpdate=true; }});
    });

    var resetBtn = document.getElementById('reset');
    if(resetBtn){
      resetBtn.addEventListener('click', function(){
        if(ui.scale) ui.scale.value = 1;
        if(ui.rotation) ui.rotation.value = 0;
        if(ui.offx) ui.offx.value = 0;
        if(ui.offy) ui.offy.value = 0;
        camera.position.set(0.9,1.5,4.2);
        controls.target.set(0,1.25,0);
        controls.update();
        if(motif){ applyTex(motif); }
      });
    }

    var dlBtn = document.getElementById('download');
    if(dlBtn){
      dlBtn.addEventListener('click', function(){
        var a = document.createElement('a');
        a.download = 'aperçu-3d.png';
        a.href = renderer.domElement.toDataURL('image/png', 0.95);
        a.click();
      });
    }

    (function loop(){
      requestAnimationFrame(loop);
      controls.update();
      renderer.render(scene, camera);
    })();
  })();
</script>
<script>
  (function autoResizeToWix(){
    function postH(){
      try{
        var h = Math.max(
          document.documentElement.scrollHeight,
          document.body ? document.body.scrollHeight : 0
        );
        parent && parent.postMessage({type:'EW_IFRAME_RESIZE', height:h}, '*');
      }catch(e){}
    }
    // Resize au chargement + sur changements de layout
    window.addEventListener('load', postH);
    window.addEventListener('resize', postH);
    new (window.ResizeObserver||function(){return {observe:function(){}}}) (postH)
      .observe(document.documentElement);
    // Garde le body scrollable si jamais
    document.documentElement.style.overflow = 'visible';
    document.body && (document.body.style.overflow = 'visible');
    // Tick au cas où des images chargent après
    setTimeout(postH, 300);
    setTimeout(postH, 1200);
  })();
</script>
